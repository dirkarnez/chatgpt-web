
<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap-grid.min.css" type="text/css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/bash.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/arduino.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/c.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/typescript.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/swift.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/lisp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/latex.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/kotlin.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/julia.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/graphql.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/go.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/glsl.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/erlang.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/dockerfile.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/dns.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/diff.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/dart.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/csharp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/sql.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/shell.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/rust.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/protobuf.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/prolog.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/processing.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/php.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/plaintext.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/matlab.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/mathematica.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/markdown.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/makefile.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/lua.min.js"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.1/dist/js.cookie.min.js"></script>
	<script src="https://github.com/dirkarnez/webpack-umd-action/releases/download/eventsource-parser.0.1.0/eventsource-parser.0.1.0.min.js"></script>
	<script>
		window.key = "OPENAI";
	</script>
	<style>
		.my-container {
		    -webkit-box-sizing: border-box;
		       -moz-box-sizing: border-box;
			    box-sizing: border-box;
		}

		textarea {
			width: 100%;
			-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				    box-sizing: border-box;
		}
		.my-container {
			padding: 10px;
		}
		
		#key {
			position: fixed;
			bottom: 0px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="row my-container">
			<div style="width: 100%;">		
				<textarea id="ask-textarea"></textarea>
				<button onclick="handleClick()">Ask</button><br>
				<div id="ans-container">
					<pre><code id="ans-code"></code></pre>
					<div id="ans-text"></div>
				</div>
				<input type="text" id="key" oninput="Cookies.set(window.key, event.target.value)">	
			</div>
		</div>
	</div>
	
	<script>
		if (!ReadableStream.prototype[Symbol.asyncIterator]) {
			ReadableStream.prototype[Symbol.asyncIterator] = async function* () {
				const reader = this.getReader();
				try {
					while (true) {
						const { done, value } = await reader.read();
						if (done) {
							return;
						}
						yield value;
					}
				}
				finally {
					reader.releaseLock();
				}
			}
		}

		async function OpenAIStream() {
			const encoder = new TextEncoder();
			const decoder = new TextDecoder();

			let counter = 0;
			const res = fetch("https://api.openai.com/v1/completions", {
				method: 'POST', // *GET, POST, PUT, DELETE, etc.
				cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${Cookies.get(window.key)}`,
				},
				body: JSON.stringify({
					// model:"text-chat-davinci-002-20230126",
					// model:"text-chat-davinci-003",

					model: "text-davinci-003",
					// model:"text-curie-001",
					prompt: document.getElementById("ask-textarea").value, //"what is the difference between fourier transform and laplace transform?",
					temperature: 0.7,
					top_p: 1,
					frequency_penalty: 0,
					presence_penalty: 0,
					max_tokens: 4000,
					stream: true,
					n: 1,
				}) // body data type must match "Content-Type" header
			});

			const stream = new ReadableStream({
				async start(controller) {
					// callback
					function onParse(event) {
						if (event.type === "event") {
							const data = event.data;
							// https://beta.openai.com/docs/api-reference/completions/create#completions/create-stream
							if (data === "[DONE]") {
								controller.close();
								return;
							}
							try {
								const json = JSON.parse(data);
								const text = json.choices[0].text;
								if (counter < 2 && (text.match(/\n/) || []).length) {
									// this is a prefix character (i.e., "\n\n"), do nothing
									return;
								}
								const queue = encoder.encode(text);
								controller.enqueue(queue);
								counter++;
							} catch (e) {
								// maybe parse error
								controller.error(e);
							}
						}
					}

					// stream response (SSE) from OpenAI may be fragmented into multiple chunks
					// this ensures we properly read chunks and invoke an event for each SSE event stream
					const parser = window.eventsourceParser.createParser(onParse);
					// https://web.dev/streams/#asynchronous-iteration

					res.then(async r => {
						for await (const chunk of r.body) {
							parser.feed(decoder.decode(chunk));
						}
					})
				},
			});

			return new Response(stream);
		}

		function handleClick(askForCode) {
			const targetElement = document.getElementById(askForCode ? "ans-code" : "ans-text");
			targetElement.innerText = "";
			
			OpenAIStream().then(async response => {
				const data = response.body;
				if (!data) {

				}
				const decoder = new TextDecoder();
				let code = "";
				
				for await (const chunk of data) {
					code += decoder.decode(chunk);
				}
				
				const detection = hljs.highlightAuto(code, ["cpp"]);
				if (!!detection.language) {
					targetElement.textContent = detection.value;
				}
			});
		}
		
		document.getElementById("key").value = Cookies.get(window.key) || "";
	</script>
</body>

</html>
